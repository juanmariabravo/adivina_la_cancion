<div class="game-container">
  <div class="game-header">
    <button class="back-button" (click)="goToLevels()"><i class="fa-solid fa-arrow-left"></i> Volver</button>
    <h1>Nivel {{ level_number }}</h1>
    <div class="attempts">Intento {{ currentAttempt }}/{{ maxAttempts }}</div>
  </div>

  <!-- Pantalla de carga -->
  <div class="loading-screen" *ngIf="!currentSong && !loadingError && message === 'Cargando nivel...'">
    <div class="loading-card">
      <div class="loading-spinner"></div>
      <h2>Cargando nivel {{ level_number }}...</h2>
      <p>Por favor espera un momento</p>
    </div>
  </div>

  <!-- Pantalla de error de carga -->
  <div class="error-screen" *ngIf="loadingError">
    <div class="error-card">
      <div class="error-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
      <h2>No se pudo cargar el nivel</h2>
      <p class="error-message">{{ message }}</p>

      <div class="error-actions">
        <button class="action-btn primary" (click)="retryLoadSong()">
          <i class="fa-solid fa-rotate-right"></i> Reintentar
        </button>
        <button class="action-btn secondary" (click)="goToLevels()">
          <i class="fa-solid fa-arrow-left"></i> Volver a Niveles
        </button>
        <button class="action-btn tertiary" (click)="goToProfile()" *ngIf="message.includes('ha expirado')">
          <i class="fa-solid fa-user"></i> Re-Conectar con Spotify
        </button>
        <button class="action-btn tertiary" (click)="goToLogin()" *ngIf="message.includes('sesión')">
          <i class="fa-solid fa-key"></i> Iniciar Sesión
        </button>
      </div>
    </div>
  </div>

  <div class="game-content" *ngIf="currentSong && !gameOver && !loadingError">
    <!-- Error de audio -->
    <div class="audio-error" *ngIf="audioError">
      <i class="fa-solid fa-triangle-exclamation"></i> {{ audioError }}
      <button class="retry-btn" (click)="startAudioManually()">Reintentar</button>
    </div>

    <!-- Imagen con reveal progresivo -->
    <div class="image-container">
      <img [src]="currentSong.image_url" [class]="'reveal-' + imageQuarters" alt="Album cover">
    </div>

    <!-- Pistas textuales -->
    <div class="hints-container">
      <div class="hint" *ngIf="revealedHints.includes('year')">
        Año: {{ currentSong.year }}
      </div>
      <div class="hint" *ngIf="revealedHints.includes('genre')">
        Género: {{ currentSong.genre }}
      </div>
      <div class="hint" *ngIf="revealedHints.includes('album')">
        Álbum: {{ currentSong.album }}
      </div>
      <div class="hint" *ngIf="revealedHints.includes('artist')">
        Artista/s: {{ currentSong.artists }}
      </div>
      <div class="hint" *ngIf="revealedHints.includes('title_hint')">
        El título empieza con: {{ currentSong.title_hint }}...
      </div>
    </div>

    <!-- Botón para iniciar el juego -->
    <div class="audio-start" *ngIf="audioReady && !gameStarted">
      <button class="play-audio-btn" (click)="startAudioManually()">
        <i class="fa-solid fa-play"></i> Comenzar
      </button>
    </div>

    <!-- Controles de audio (solo cuando el juego ha comenzado) -->
    <div class="audio-controls" *ngIf="gameStarted && !gameOver">
      <button class="replay-audio-btn" (click)="replayAudio()" [disabled]="!canReplayAudio"
        [class.disabled]="!canReplayAudio">
        <i class="fa-solid fa-rotate-left"></i>
      </button>
    </div>

    <!-- Input respuesta (deshabilitado hasta que comience) -->
    <input type="text" [(ngModel)]="userAnswer" placeholder="¿Cuál es el título de la canción?"
      (keyup.enter)="submitAnswer()">
    <button class="submit-btn" (click)="submitAnswer()" [disabled]="!gameStarted || gameOver">
      Responder
    </button>
    <button class="hint-btn" (click)="nextHint()" *ngIf="currentAttempt < maxAttempts"
      [disabled]="!gameStarted || gameOver">
      Siguiente Pista
    </button>
    <button class="give-up-btn" (click)="giveUp()" *ngIf="currentAttempt === maxAttempts">
      Me rindo
    </button>

    <div class="message" *ngIf="message">{{ message }}</div>
  </div>

  <!-- Pantalla de resultado -->
  <div class="result-screen" *ngIf="gameOver">
    <div class="result-card" [class.correct]="isCorrect" [class.incorrect]="!isCorrect">
      <h2>{{ isCorrect ? '¡Correcto!' : 'Fin del Juego' }}</h2>
      <p class="result-message">{{ message }}</p>

      <div class="song-reveal" *ngIf="showAnswer">
        <img [src]="currentSong!.image_url" alt="Portada" class="reveal-image">
        <h3>{{ currentSong!.title }}</h3>
        <p>{{ currentSong!.artists }}</p>
        <p class="album">{{ currentSong!.album }} ({{ currentSong!.year }})</p>
      </div>

      <div class="score-display" *ngIf="isCorrect && !isGuest">
        <div *ngIf="!alreadyPlayed">
          <h3>Puntuación: {{ score }} puntos</h3>
          <p>Intentos: {{ currentAttempt }}/{{ maxAttempts }}</p>
        </div>
        <div *ngIf="alreadyPlayed" class="already-completed-message">
          <h3><i class="fa-solid fa-circle-info"></i> Este nivel ya ha sido jugado antes</h3>
          <p>No se añadirán puntos adicionales a tu puntuación total.</p>
        </div>
      </div>

      <div class="result-actions">
        <div class="actions">
          <button (click)="playAgain()" class="action-btn secondary">Jugar de nuevo</button>
          <button (click)="nextLevel()" class="action-btn primary" *ngIf="nextLevelButtonEnabled">Siguiente Nivel</button>
          <button (click)="goToLevels()" class="action-btn secondary">Volver a niveles</button>
        </div>
      </div>
    </div>
  </div>
</div>