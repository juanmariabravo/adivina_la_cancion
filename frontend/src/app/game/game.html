<div class="game-container">
  <div class="game-header">
    <button class="back-button" (click)="goToLevels()">â† Volver</button>
    <h1>Nivel {{ level_number }}</h1>
    <div class="attempts">Intento {{ currentAttempt }}/{{ maxAttempts }}</div>
  </div>

  <!-- Pantalla de carga -->
  <div class="loading-screen" *ngIf="!currentSong && !loadingError && message === 'Cargando nivel...'">
    <div class="loading-card">
      <div class="loading-spinner"></div>
      <h2>Cargando nivel {{ level_number }}...</h2>
      <p>Por favor espera un momento</p>
    </div>
  </div>

  <!-- Pantalla de error de carga -->
  <div class="error-screen" *ngIf="loadingError">
    <div class="error-card">
      <div class="error-icon">âš ï¸</div>
      <h2>No se pudo cargar el nivel</h2>
      <p class="error-message">{{ message }}</p>
      
      <div class="error-actions">
        <button class="action-btn primary" (click)="retryLoadSong()">
          ğŸ”„ Reintentar
        </button>
        <button class="action-btn secondary" (click)="goToLevels()">
          â† Volver a Niveles
        </button>
        <button class="action-btn tertiary" (click)="goToProfile()" *ngIf="message.includes('Spotify')">
          ğŸ‘¤ Ir a Perfil
        </button>
        <button class="action-btn tertiary" (click)="goToLogin()" *ngIf="message.includes('sesiÃ³n')">
          ğŸ”‘ Iniciar SesiÃ³n
        </button>
      </div>
    </div>
  </div>

  <div class="game-content" *ngIf="currentSong && !gameOver && !loadingError">
    <!-- Error de audio -->
    <div class="audio-error" *ngIf="audioError">
      âš ï¸ {{ audioError }}
      <button class="retry-btn" (click)="startAudioManually()">Reintentar</button>
    </div>

    <!-- Imagen con reveal progresivo -->
    <div class="image-container">
      <img [src]="currentSong.image_url" [class]="'reveal-' + imageQuarters" alt="Album cover">
    </div>

    <!-- Pistas textuales -->
    <div class="hints-container">
      <div class="hint" *ngIf="revealedHints.includes('year')">
        AÃ±o: {{ currentSong.year }}
      </div>
      <div class="hint" *ngIf="revealedHints.includes('genre')">
        GÃ©nero: {{ currentSong.genre }}
      </div>
      <div class="hint" *ngIf="revealedHints.includes('album')">
        Ãlbum: {{ currentSong.album }}
      </div>
      <div class="hint" *ngIf="revealedHints.includes('artist')">
        Artista/s: {{ currentSong.artists }}
      </div>
      <div class="hint" *ngIf="revealedHints.includes('title_hint')">
        El tÃ­tulo empieza con: {{ currentSong.title_hint }}...
      </div>
    </div>

      <!-- BotÃ³n para iniciar el juego -->
    <div class="audio-start" *ngIf="audioReady && !gameStarted">
      <button class="play-audio-btn" (click)="startAudioManually()">
        â–¶ Comenzar
      </button>
    </div>

    <!-- Controles de audio (solo cuando el juego ha comenzado) -->
    <div class="audio-controls" *ngIf="gameStarted && !gameOver">
      <button 
        class="replay-audio-btn" 
        (click)="replayAudio()"
        [disabled]="!canReplayAudio"
        [class.disabled]="!canReplayAudio"
      >
        ğŸ”
      </button>
    </div>

    <!-- Input respuesta (deshabilitado hasta que comience) -->
      <input 
        type="text" 
        [(ngModel)]="userAnswer" 
        placeholder="Â¿CuÃ¡l es el tÃ­tulo de la canciÃ³n?"
        (keyup.enter)="submitAnswer()"
      >
      <button 
        class="submit-btn" 
        (click)="submitAnswer()"
        [disabled]="!gameStarted || gameOver"
      >
        Responder
      </button>
      <button 
        class="hint-btn" 
        (click)="nextHint()" 
        *ngIf="currentAttempt < maxAttempts"
        [disabled]="!gameStarted || gameOver"
      >
        Siguiente Pista
      </button>
      <button 
        class="give-up-btn" 
        (click)="giveUp()" 
        *ngIf="currentAttempt === maxAttempts"
      >
        Me rindo
      </button>

    <div class="message" *ngIf="message">{{ message }}</div>
  </div>

  <!-- Pantalla de resultado -->
  <div class="result-screen" *ngIf="gameOver">
    <div class="result-card" [class.correct]="isCorrect" [class.incorrect]="!isCorrect">
      <h2>{{ isCorrect ? 'Â¡Correcto!' : 'Fin del Juego' }}</h2>
      <p class="result-message">{{ message }}</p>
      
      <div class="song-reveal" *ngIf="showAnswer">
        <img [src]="currentSong!.image_url" alt="Portada" class="reveal-image">
        <h3>{{ currentSong!.title }}</h3>
        <p>{{ currentSong!.artists }}</p>
        <p class="album">{{ currentSong!.album }} ({{ currentSong!.year }})</p>
      </div>

      <div class="score-display" *ngIf="isCorrect && !isGuest">
        <div *ngIf="!alreadyCompleted">
          <h3>PuntuaciÃ³n: {{ score }} puntos</h3>
          <p>Intentos: {{ currentAttempt }}/{{ maxAttempts }}</p>
        </div>
        <div *ngIf="alreadyCompleted" class="already-completed-message">
          <h3>â„¹ï¸ Este nivel ya ha sido completado anteriormente</h3>
          <p>No se han aÃ±adido puntos adicionales</p>
        </div>
      </div>

      <div class="result-actions">
        <button class="action-btn primary" (click)="playAgain()">
          Jugar de Nuevo
        </button>
        <button class="action-btn secondary" (click)="goToLevels()">
          Volver a Niveles
        </button>
      </div>
    </div>
  </div>
</div>